name: Build and upload binaries

on:
    create:

jobs:
    build:
        if: |
            (github.event.ref_type == 'branch' && startsWith(github.event.ref, 'releases/')) ||
            github.event.ref_type == 'tag'
        runs-on: ubuntu-latest
        strategy:
            matrix:
                go-version: ['1.24']
                os: [linux, darwin, windows]
                arch: [amd64, arm64]
            fail-fast: false

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                go-version: ${{ matrix.go-version }}

            - name: Cache Go build & modules
              uses: actions/cache@v4
              with:
                path: |
                 ~/.cache/go-build
                 ~/go/pkg/mod
                key: ${{ runner.os }}-go-${{ matrix.go-version }}-${{ hashFiles('**/go.sum') }}
                restore-keys: |
                    ${{ runner.os }}-go-${{ matrix.go-version }}-

            - name: Build binary
              env:
                GOOS: ${{ matrix.os }}
                GOARCH: ${{ matrix.arch }}
              run: |
                set -e
                mkdir -p bin/${GOOS}-${GOARCH}
                out=bin/${GOOS}-${GOARCH}/domain-tool-updater
                if [ "${GOOS}" = "windows" ]; then out=${out}.exe; fi
                GOOS=${GOOS} GOARCH=${GOARCH} go build -ldflags="-s -w" -o "${out}" .

            - name: Upload binaries artifact
              uses: actions/upload-artifact@v4
              with:
                name: domain-tool-updater-binaries
                path: bin/**